#include "Step.h"

int Count = 0;
 
/*- S型加减速曲线，PWM输出频率表 -*/ 
u16 value2[]=
{
	994,994,994,994,992,992,992,992,992,990,990,990,990,988,988,988,986,986,986,984, 
	984,982,982,982,980,980,978,978,976,974,974,972,970,970,968,966,964,964,962,960,
	958,956,954,950,948,946,944,940,938,934,932,928,926,922,918,914,910,906,902,898,
	892,887,882,877,872,866,860,855,848,842,835,828,821,814,807,799,791,783,775,766,
	758,750,740,730,720,712,702,692,682,670,660,650,638,628,616,606,594,584,572,562,
	550,538,528,516,506,494,484,472,462,450,440,430,418,408,398,388,380,370,360,350,  
	342,334,324,316,308,300,292,286,278,272,264,258,252,244,240,234,228,222,218,212,
	208,202,198,194,190,186,182,178,174,172,168,166,162,160,156,154,152,150,146,144,
	142,140,138,136,136,134,132,130,130,128,126,126,124,122,122,120,120,118,118,118,
	116,116,114,114,114,112,112,112,110,110,110,110,108,108,108,108,108,106,106,106,
	106
};

u16 value1[]=
{ 
	994,994,994,992,992,992,992,992,990,990,990,990,988,988,988,986,986,986,984,984,
	984,982,982,980,980,978,978,976,974,974,972,972,970,968,966,964,964,962,960,958,
	956,954,950,948,946,944,940,938,936,932,928,926,922,918,914,910,906,902,898,892,
	888,882,878,872,866,860,854,848,842,836,828,822,814,806,798,790,782,774,766,756,
	748,738,728,718,708,698,688,678,666,656,646,634,622,612,600,588,576,566,554,542,
	530,518,506,494,484,472,460,448,438,426,414,404,394,382,372,362,352,342,332,322,
	312,304,294,286,278,270,262,254,246,238,232,224,218,212,206,200,194,188,182,178,
	172,168,162,158,154,150,146,142,138,134,132,128,124,122,120,116,114,112,110,106,
	104,102,100,98 ,96 ,96 ,94 ,92 ,90 ,88 ,88 ,86 ,86 ,84 ,82 ,82 ,80 ,80 ,78 ,78 ,
	76 ,76 ,76 ,74 ,74 ,74 ,72 ,72 ,72 ,70 ,70 ,70 ,70 ,68 ,68 ,68 ,68 ,68 ,66 ,66 ,
	66
};

u16  value[]=
{
	596,596,596,596,596,596,596,594,594,594,594,594,594,594,592,592,592,592,592,590,
	590,590,590,588,588,588,586,586,586,584,584,584,582,582,580,580,578,578,576,576,
	574,574,572,570,570,568,566,564,562,560,560,558,556,552,550,548,546,544,542,538,
	536,532,530,526,524,520,516,514,510,506,502,498,494,488,484,480,476,470,466,460,
	454,450,444,438,432,426,420,414,408,402,396,390,384,376,370,364,356,350,344,336,
	330,324,316,310,304,296,290,284,276,270,264,258,252,246,240,234,228,222,216,210,
	206,200,194,190,184,180,176,172,166,162,158,154,150,146,144,140,136,134,130,128,
	124,122,118,116,114,112,110,108,104,102,100,100,98 ,96 ,94 ,92 ,90 ,90 ,88 ,86 ,
	86 ,84 ,84 ,82 ,82 ,80 ,80 ,78 ,78 ,76 ,76 ,76 ,74 ,74 ,74 ,72 ,72 ,72 ,70 ,70 ,
	70 ,70 ,68 ,68 ,68 ,68 ,68 ,66 ,66 ,66 ,66 ,66 ,66 ,66 ,64 ,64 ,64 ,64 ,64 ,64 ,
	64
};

/*- 电机加速 -*/
void Speed_up(void)
{
	for(Count = 0; Count<201; Count++)
	{
		delay_us(1*value[0]); 												//N个脉冲后加载预装载值和占空比
		TIM_SetAutoreload(TIM2,value[Count]*4);
		TIM_SetAutoreload(TIM3,value[Count]*4);
		TIM_SetAutoreload(TIM4,value[Count]*4);
		TIM_SetAutoreload(TIM5,value[Count]*4);
		TIM_SetCompare1(TIM2,value[Count]/2);
		TIM_SetCompare1(TIM3,value[Count]/2);
		TIM_SetCompare1(TIM4,value[Count]/2);
		TIM_SetCompare1(TIM5,value[Count]/2);
	}
}
 
/*- 电机减速 -*/
void Speed_down(void)
{
	for(Count = 200; Count >= 0; Count--)
	{
		delay_us(1*value[0]);                     			//N个脉冲后加载预装载值和占空比
		TIM_SetAutoreload(TIM2,value[Count]*4);
		TIM_SetAutoreload(TIM3,value[Count]*4);
		TIM_SetAutoreload(TIM4,value[Count]*4);
		TIM_SetAutoreload(TIM5,value[Count]*4);
		TIM_SetCompare1(TIM2,value[Count]/2);
		TIM_SetCompare1(TIM3,value[Count]/2);
		TIM_SetCompare1(TIM4,value[Count]/2);
		TIM_SetCompare1(TIM5,value[Count]/2);
	}
}

void PWM_Ctrl(FunctionalState NewState)							//PWM开关
{
	TIM_Cmd(TIM2, NewState);
	TIM_Cmd(TIM3, NewState);
	TIM_Cmd(TIM4, NewState);
	TIM_Cmd(TIM5, NewState);
}

void DIR(void)
{
	DIR1 = !DIR1;
	DIR2 = !DIR2;
	DIR3 = !DIR3;
	DIR4 = !DIR4;
}
